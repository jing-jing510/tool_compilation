<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
<script>
      document.getElementById('fenjingButton').addEventListener('click', function () {
        // 读取原文.txt文件的内容
        fetch('/read_file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({filename: '原文.txt'}),
        })
            .then(response => response.json())
            .then(data => {
                const textLines = data.text.split('\n');

                // 清空表格，只保留标题行
                const table = document.getElementById('fenjingTable');
                while (table.rows.length > 1) {
                    table.deleteRow(1);
                }

                // 将文本的每一行都添加到表格中
                for (const text of textLines) {
                    const row = table.insertRow();
                    const textCell = row.insertCell();
                    textCell.textContent = text;
                    textCell.contentEditable = "true";
                    const aiCell = row.insertCell();
                    aiCell.textContent = '正在计算...';
                    aiCell.contentEditable = "true";

                    // 调用后端的API获取AI分镜的结果
                    fetch('/ai_fenjing', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({text: text}),
                    })
                        .then(response => response.json())
                        .then(data => {
                            // 更新表格中的内容
                            aiCell.textContent = data.result;
                        });
                    // 添加新的列，包含一个"重绘"按钮
                    const redrawCell = row.insertCell();
                    const redrawButton = document.createElement('button');
                    redrawButton.textContent = '重绘';
                    redrawButton.addEventListener('click', function () {
                        // 点击按钮时，获取当前行的“原文”列的内容
                        const text = textCell.textContent;

                        // 重新执行 ai_fenjing 方法
                        fetch('/ai_fenjing', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({text: text}),
                        })
                            .then(response => response.json())
                            .then(data => {
                                // 更新 AI 分镜列的内容
                                aiCell.textContent = data.result;
                            });
                    });
                    redrawCell.appendChild(redrawButton);
                }
            });
    });
</script>
</html>